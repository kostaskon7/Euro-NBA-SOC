<script>
async function loadJSON(filename) {
  const response = await fetch(filename);
  if (!response.ok) {
    throw new Error(`Could not load ${filename}: ${response.statusText}`);
  }
  return response.json();
}

// Compute SOS function (similar logic as before)
function computeSOS(standings, futureGames, n_games=5) {
  const rankings = {};
  standings.forEach(t => { rankings[t.teamCode] = t.ranking; });
  const teams = [...new Set(standings.map(t => t.teamCode))];

  let results = [];

  teams.forEach(team => {
    const homeGames = futureGames.filter(g => g.homecode === team).map(g => ({...g, opponent: g.awaycode}));
    const awayGames = futureGames.filter(g => g.awaycode === team).map(g => ({...g, opponent: g.homecode}));

    let nextGames = homeGames.concat(awayGames);
    nextGames.sort((a,b) => new Date(a.date) - new Date(b.date));
    nextGames = nextGames.slice(0, n_games);

    if(nextGames.length === 0) {
      const teamObj = standings.find(s => s.teamCode === team);
      results.push({
        teamCode: team,
        teamName: teamObj ? teamObj.teamName : team,
        SOS: null,
        gamesRemaining: 0,
        opponents: [],
        opponentRankings: [],
        gameDates: [],
        gameCodes: []
      });
      return;
    }

    const oppCodes = nextGames.map(g => g.opponent);
    const oppRankings = oppCodes.map(c => rankings[c] ?? null);
    const sos = oppRankings.reduce((a,v) => a + v, 0) / oppRankings.length;

    const teamObj = standings.find(s => s.teamCode === team);

    results.push({
      teamCode: team,
      teamName: teamObj ? teamObj.teamName : team,
      SOS: sos,
      gamesRemaining: nextGames.length,
      opponents: oppCodes,
      opponentRankings: oppRankings,
      gameDates: nextGames.map(g => g.date),
      gameCodes: nextGames.map(g => g.gamecode)
    });
  });

  results.sort((a,b) => (a.SOS ?? Infinity) - (b.SOS ?? Infinity));
  return results;
}

// Render table function (from before)
function renderSOS(data) {
  const container = document.getElementById("sos-container");
  let html = '<table><thead><tr>' +
    '<th>Team</th>' +
    '<th>SOS</th>' +
    '<th>Games Remaining</th>' +
    '<th>Opponents (Codes)</th>' +
    '<th>Opponent Rankings</th>' +
    '<th>Game Dates</th>' +
    '<th>Game Codes</th>' +
    '</tr></thead><tbody>';

  data.forEach(team => {
    const opponents = team.opponents.join('\n');
    const opponentRankings = team.opponentRankings.join('\n');
    const gameDates = team.gameDates.map(d => new Date(d).toLocaleDateString()).join('\n');
    const gameCodes = team.gameCodes.join('\n');

    html += `<tr>
      <td>${team.teamName} (${team.teamCode})</td>
      <td>${team.SOS !== null ? team.SOS.toFixed(2) : 'N/A'}</td>
      <td>${team.gamesRemaining}</td>
      <td class="opponents">${opponents}</td>
      <td class="opponentRankings">${opponentRankings}</td>
      <td class="gameDates">${gameDates}</td>
      <td class="gameCodes">${gameCodes}</td>
    </tr>`;
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

// Main async to load data and process
async function main() {
  try {
    const standings = await loadJSON('standings.json');
    const futureGames = await loadJSON('future_games.json');
    // Assuming your JSON structure matches the expected array format, 
    // if they are nested, you may need to extract the arrays similarly to Python version.
    
    const sos = computeSOS(standings, futureGames, 5);
    renderSOS(sos);
  } catch (e) {
    document.getElementById("sos-container").innerText = "Error loading data: " + e.message;
  }
}

main();
</script>
